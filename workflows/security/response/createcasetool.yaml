# =============================================================================
# Workflow: Create Case
# Category: security/response
#
# Creates a new Elastic Security case for tracking incidents and
# investigations. Uses explicit HTTP auth to work reliably when invoked
# through the agent mesh subagent chain.
#
# Author: Security Agent Mesh
# =============================================================================
name: Create Case
description: Create an Elastic Security case for incident tracking.
enabled: true

tags:
  - agent-mesh
  - response
  - cases

triggers:
  - type: manual

inputs:
  - name: caseTitle
    required: true
    type: string
    description: "Title for the case"
  - name: caseDescription
    required: true
    type: string
    description: "Detailed description of the incident or investigation"
  - name: severity
    type: string
    description: "Case severity: low, medium, high, critical"
    default: "medium"

steps:

  - name: create_case
    type: http
    with:
      method: POST
      url: "__KIBANA_URL__/s/__KIBANA_SPACE__/api/cases"
      headers:
        Content-Type: application/json
        Authorization: "ApiKey __KIBANA_API_KEY__"
        kbn-xsrf: "true"
      body:
        title: "{{ inputs.caseTitle }}"
        description: "{{ inputs.caseDescription }}"
        owner: "securitySolution"
        tags:
          - agent-mesh
          - auto-generated
        severity: "{{ inputs.severity }}"
        connector:
          id: "none"
          name: "none"
          type: ".none"
          fields: null
        settings:
          syncAlerts: true

  - name: confirm
    type: console
    with:
      message: |
        Case created successfully.
        Case ID: {{ steps.create_case.output.data.id }}
        Title: {{ steps.create_case.output.data.title }}
        Severity: {{ steps.create_case.output.data.severity }}
        Owner: {{ steps.create_case.output.data.owner }}
