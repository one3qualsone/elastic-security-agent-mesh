# =============================================================================
# Workflow: Evaluate MITRE ATT&CK Coverage
# Category: security/detection
#
# Fetches all enabled detection rules, extracts their MITRE technique
# mappings, and compares against the ATT&CK knowledge base to identify
# coverage gaps. Uses explicit HTTP auth for subagent chain reliability.
#
# Author: Security Agent Mesh
# =============================================================================
name: Evaluate MITRE Coverage
description: Identify gaps in MITRE ATT&CK technique coverage across detection rules.
enabled: true

tags:
  - agent-mesh
  - detection-engineering
  - mitre

triggers:
  - type: manual

inputs:
  - name: enabled_only
    type: boolean
    description: "Only evaluate enabled rules (recommended for production coverage)"
    default: true
  - name: tactic_filter
    type: string
    description: "Filter to a specific tactic (e.g., 'Initial Access', 'Execution'). Leave empty for all."
    required: false

steps:

  - name: fetch_all_rules
    type: http
    with:
      method: GET
      url: "__KIBANA_URL__/s/__KIBANA_SPACE__/api/detection_engine/rules/_find?per_page=1000&sort_field=name&sort_order=asc"
      headers:
        Authorization: "ApiKey __KIBANA_API_KEY__"
        kbn-xsrf: "true"

  - name: extract_coverage
    type: console
    with:
      message: |
        {% assign rules = steps.fetch_all_rules.output.data.data %}
        {% assign total_rules = steps.fetch_all_rules.output.data.total %}
        {% assign covered_techniques = "" | split: "" %}
        {% assign covered_count = 0 %}
        {% for rule in rules %}
          {% if inputs.enabled_only == true and rule.enabled == false %}{% continue %}{% endif %}
          {% if rule.threat %}
            {% for threat in rule.threat %}
              {% if threat.technique %}
                {% for technique in threat.technique %}
                  {% unless covered_techniques contains technique.id %}
                    {% assign covered_techniques = covered_techniques | push: technique.id %}
                    {% assign covered_count = covered_count | plus: 1 %}
                  {% endunless %}
                {% endfor %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
        Total rules: {{ total_rules }}
        Unique MITRE techniques covered: {{ covered_count }}
        Techniques: {{ covered_techniques | join: ", " }}

  - name: search_kb_techniques
    type: http
    with:
      method: POST
      url: "__ES_URL__/kb-mitre-attack/_search"
      headers:
        Content-Type: application/json
        Authorization: "ApiKey __ES_API_KEY__"
      body:
        size: 0
        track_total_hits: true
        query:
          match_all: {}
    on-failure:
      continue: true

  - name: output_summary
    type: console
    with:
      message: |
        === MITRE ATT&CK Coverage Report ===
        Total detection rules evaluated: {{ steps.fetch_all_rules.output.data.total }}
        Enabled only: {{ inputs.enabled_only }}
        {% if inputs.tactic_filter %}Tactic filter: {{ inputs.tactic_filter }}{% endif %}
        Total techniques in KB: {{ steps.search_kb_techniques.output.data.hits.total.value }}
