# =============================================================================
# Workflow: Hash Threat Check
# Category: security/detection
#
# The "Hash Threat Check" workflow is designed to verify file hashes (MD5,
# SHA-1, SHA-256) against the VirusTotal database for potential malware
# threats. It includes steps for looking up the file hash, retrieving
# detailed analysis, and formatting the results into a comprehensive report.
# The workflow is triggered manually and incorporates error handling with
# retry mechanisms for API calls, ensuring robust execution. The final output
# provides a detailed threat assessment based on the analysis results.
#
# Author: Elastic
# Created: 2025-11-13
# =============================================================================
name: Hash Threat Check
description: Check file hashes (MD5, SHA-1, SHA-256) against VirusTotal database for malware detection.

# ---------------------------------------------------------------------------
# CONSTANTS
# ---------------------------------------------------------------------------
# Reusable configuration values defined once and referenced throughout the
# workflow using {{ consts.key_name }} syntax. Use constants for:
#   - API endpoints and URLs
#   - API keys and authentication tokens (use secrets in production)
#   - Environment-specific configuration
#   - Values that may need to change across environments
# ---------------------------------------------------------------------------
consts:
  virustotal_api_key: API-KEY
  virustotal_base_url: https://www.virustotal.com/api/v3

# ---------------------------------------------------------------------------
# INPUTS
# ---------------------------------------------------------------------------
# Runtime parameters provided when the workflow is triggered. Each input
# can specify:
#   - name: Unique identifier for the input
#   - type: Data type (string, number, boolean, array, object)
#   - required: Whether the input must be provided (default: false)
#   - default: Default value if not provided
# Reference inputs in steps using {{ inputs.input_name }} syntax
# ---------------------------------------------------------------------------
inputs:
  - name: file_hash
    type: string
    description:
      The file hash to check (MD5, SHA-1, or SHA-256 format) for malware
      and threat intelligence
    required: true

# ---------------------------------------------------------------------------
# TRIGGERS
# ---------------------------------------------------------------------------
# Defines how and when this workflow is executed. Supported trigger types:
#   - manual: Run on-demand from the Kibana UI or API
#   - scheduled: Run on a recurring schedule (every: "5m" or rrule)
#   - alert: Run automatically when a security alert is triggered
# ---------------------------------------------------------------------------
triggers:
  - type: manual

# ---------------------------------------------------------------------------
# STEPS
# ---------------------------------------------------------------------------
# The sequence of actions this workflow performs. Each step executes an
# action and can reference outputs from previous steps. Key properties:
#   - name: Unique identifier for referencing this step's output
#   - type: The action to perform (http, elasticsearch.search, foreach, etc.)
#   - with: Parameters passed to the action
#   - condition: Optional expression to conditionally run the step
#   - on-failure: Error handling configuration (retry, continue, etc.)
# Access step outputs using {{ steps.step_name.output.field }} syntax
# ---------------------------------------------------------------------------
steps:

# -------------------------------------------------------------------------
# STEP 1: lookup_file_hash
# -------------------------------------------------------------------------
# Makes an API call to VirusTotal to check for malicious indicators.
# Returns threat intelligence data including detection results and
# reputation scores.
# Includes retry logic to handle transient failures gracefully.
# Liquid syntax used:
# - References workflow input parameter(s)
# - References workflow constant(s)
# -------------------------------------------------------------------------
- name: lookup_file_hash
  type: http
  with:
    url: "{{ consts.virustotal_base_url }}/files/{{ inputs.file_hash }}"
    method: GET
    headers:
      x-apikey: "{{ consts.virustotal_api_key }}"
      Accept: application/json
  on-failure:
    retry:
      max-attempts: 2
      delay: 3s
    continue: true

# -------------------------------------------------------------------------
# STEP 2: get_detailed_analysis
# -------------------------------------------------------------------------
# Makes an API call to VirusTotal to check for malicious indicators.
# Returns threat intelligence data including detection results and
# reputation scores.
# Includes retry logic to handle transient failures gracefully.
# Liquid syntax used:
# - References workflow input parameter(s)
# - References workflow constant(s)
# -------------------------------------------------------------------------
- name: get_detailed_analysis
  type: http
  with:
    url: "{{ consts.virustotal_base_url }}/files/{{ inputs.file_hash }}/behaviours"
    method: GET
    headers:
      x-apikey: "{{ consts.virustotal_api_key }}"
      Accept: application/json
  on-failure:
    continue: true

# -------------------------------------------------------------------------
# STEP 3: format_results
# -------------------------------------------------------------------------
# Formats and displays the results in a human-readable report format.
# This output is visible in the workflow execution logs.
# Liquid syntax used:
# - `{% if %}` - Conditional logic based on expression
# - `{% elsif %}` - Additional condition branch
# - References output from previous step(s)
# - References workflow input parameter(s)
# -------------------------------------------------------------------------
- name: format_results
  type: console
  with:
    message: |
      === File Hash Threat Analysis Report ===
      File Hash: {{ inputs.file_hash }}
      
      VirusTotal Analysis:
      - File Name: {{ steps.lookup_file_hash.output.data.data.attributes.meaningful_name }}
      - File Type: {{ steps.lookup_file_hash.output.data.data.attributes.type_description }}
      - File Size: {{ steps.lookup_file_hash.output.data.data.attributes.size }} bytes
      - First Seen: {{ steps.lookup_file_hash.output.data.data.attributes.first_submission_date }}
      - Last Analysis: {{ steps.lookup_file_hash.output.data.data.attributes.last_analysis_date }}
      
      Detection Results:
      - Malicious Detections: {{ steps.lookup_file_hash.output.data.data.attributes.last_analysis_stats.malicious }}
      - Suspicious Detections: {{ steps.lookup_file_hash.output.data.data.attributes.last_analysis_stats.suspicious }}
      - Undetected: {{ steps.lookup_file_hash.output.data.data.attributes.last_analysis_stats.undetected }}
      - Total Scans: {{ steps.lookup_file_hash.output.data.data.attributes.last_analysis_stats.malicious | plus: steps.lookup_file_hash.output.data.data.attributes.last_analysis_stats.suspicious | plus: steps.lookup_file_hash.output.data.data.attributes.last_analysis_stats.undetected }}
      
      File Hashes (Cross-reference):
      - MD5: {{ steps.lookup_file_hash.output.data.data.attributes.md5 }}
      - SHA-1: {{ steps.lookup_file_hash.output.data.data.attributes.sha1 }}
      - SHA-256: {{ steps.lookup_file_hash.output.data.data.attributes.sha256 }}

      Community Reputation:
      - Reputation Score: {{ steps.lookup_file_hash.output.data.data.attributes.reputation }}
      - Total Votes: {{ steps.lookup_file_hash.output.data.data.attributes.total_votes.harmless | plus: steps.lookup_file_hash.output.data.data.attributes.total_votes.malicious }}
      
      Threat Assessment:
      {% if steps.lookup_file_hash.output.data.data.attributes.last_analysis_stats.malicious > 5 %}
      � MALWARE DETECTED - Multiple AV engines flagged this file as malicious
      {% elsif steps.lookup_file_hash.output.data.data.attributes.last_analysis_stats.malicious > 0 %}
      ⚠️ POTENTIALLY MALICIOUS - Some AV engines detected threats
      {% elsif steps.lookup_file_hash.output.data.data.attributes.last_analysis_stats.suspicious > 0 %}
      ⚡ SUSPICIOUS - File shows suspicious characteristics
      {% else %}
      ✓ CLEAN - No malicious detections found
      {% endif %}