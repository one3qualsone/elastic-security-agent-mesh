name: Deploy Security Agent Mesh

on:
  workflow_dispatch:
    inputs:
      action:
        description: "What to deploy"
        required: true
        type: choice
        options:
          - full-setup
          - agents-only
          - delete-all-redeploy
          - validate
        default: full-setup

env:
  ELASTIC_CLOUD_URL: ${{ secrets.ELASTIC_CLOUD_URL }}
  KIBANA_URL: ${{ secrets.KIBANA_URL }}
  ES_API_KEY: ${{ secrets.ES_API_KEY }}
  KIBANA_API_KEY: ${{ secrets.KIBANA_API_KEY }}
  KIBANA_SPACE: ${{ secrets.KIBANA_SPACE }}
  INFERENCE_ENDPOINT_ID: ${{ secrets.INFERENCE_ENDPOINT_ID }}
  VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
  ABUSEIPDB_API_KEY: ${{ secrets.ABUSEIPDB_API_KEY }}
  LLM_CONNECTOR_ID: ${{ secrets.LLM_CONNECTOR_ID }}


jobs:
  deploy:
    name: Deploy to Elastic Cloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install requests pyyaml

      - name: Validate environment
        run: python scripts/setup.py --validate

      - name: Run setup
        if: inputs.action != 'validate'
        run: |
          case "${{ inputs.action }}" in
            full-setup)
              python scripts/setup.py
              ;;
            agents-only)
              python scripts/setup.py --agents-only
              ;;
            delete-all-redeploy)
              python scripts/setup.py --delete-all
              ;;
          esac

      - name: Print summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Action** | \`${{ inputs.action }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target** | \`${KIBANA_URL}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Space** | \`${KIBANA_SPACE:-default}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Inference** | \`${INFERENCE_ENDPOINT_ID:-.multilingual-e5-small-elasticsearch}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps (Phase 2)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Create \`security-mesh.agent-registry\` Index Search tool in Agent Builder UI" >> $GITHUB_STEP_SUMMARY
          echo "2. Set up MCP web search tools (optional) â€” see README" >> $GITHUB_STEP_SUMMARY
          echo "3. Assign LLM connector to each agent in Agent Builder UI" >> $GITHUB_STEP_SUMMARY
          echo "4. Re-run with \`agents-only\` to sync manual tools to agents" >> $GITHUB_STEP_SUMMARY
          echo "5. Seed knowledge bases (kb-mitre-attack, kb-ecs-schema, kb-detection-rules)" >> $GITHUB_STEP_SUMMARY
